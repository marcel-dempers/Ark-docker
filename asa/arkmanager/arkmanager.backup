#!/bin/bash

instance=$1

if [ -z "$instance" ]
then
      echo "must supply instance, e.g @island"
      exit
fi

instance="${instance:1}"

datestamp="$(date +"%Y-%m-%d_%H.%M.%S")"
backupdir="${BACKUP_DIR}/${instance}-${datestamp}"
saverootdir="${ARK_DIR}/ShooterGame/Saved/SavedArks/${MAP_NAME}"

echo "creating backup ${instance}... ${backupdir}"
mkdir -p ${backupdir}

echo "copying profiles ..."
cp -r ${saverootdir}/*.arkprofile ${backupdir}
cp -r ${saverootdir}/*.profilebak ${backupdir}

echo "copying tribe data ..."
cp -r ${saverootdir}/*.arktribe ${backupdir}
cp -r ${saverootdir}/*.tribebak ${backupdir}

echo "copying map data ..."
cp -r ${saverootdir}/${MAP_NAME}.ark ${backupdir}
echo "copying bak files ..."
cp -r ${saverootdir}/*.bak ${backupdir}

echo "files copied: "
ls -la ${backupdir}

backupfile="${backupdir}.bz2"
echo "compressing backup... ${backupfile}"
tar -jcf "${backupfile}" -C "${BACKUP_DIR}" "${instance}-${datestamp}"

if test -f /etc/s3cfg/.s3cfg; then
  echo "s3cmd configured, uploading to S3 ..."
  s3cmd --config /etc/s3cfg/.s3cfg put ${backupfile} "s3://ark-backups/${instance}/${instance}-latest.bz2"

  s3cmd --config /etc/s3cfg/.s3cfg put ${backupfile} "s3://ark-backups/${instance}/timestamped/${instance}-${datestamp}.bz2"
fi